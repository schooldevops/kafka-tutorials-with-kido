# Kafka Consumer Group 의 동작

- Kafka Consumer Group은 kafka의 컨슈머들이 등록된 그룹을 말한다. 
- consumer group은 컨슈머들이 특정 토픽의 파티션에 매핑될 수 있는 코디네이션 작업을 수행하게 된다. 

## Consumer Group의 컨슈머 상태정보 

- Consumer는 다음과 같은 상태값을 노출한다. 
- 상태정보
  - Stable:
    - 컨슈머 그룹 내의 모든 컨슈머 인스턴스가 정상적으로 동작 중인 상태
    - 모든 파티션에 대해 컨슈밍이 정상적으로 이루어지고 있음을 나타낸다. 
  - Joining:
    - 새로운 컨슈머 인스턴스가 컨슈머 그룹에 합류하고 있는 상태
    - 이 상태에서는 컨슈머가 파티션 할당을 받기 위해 그룹 코디네이터에게 요청하고 있다. 
  - Preparing Rebalance
    - 리밸런싱이 진행중인 상태를 나타낸다. 
    - 컨슈머 그룹 내에서 파티션의 할당이 변경되고 있거나, 새로운 컨슈머가 추가 되었음을 나타낸다. 
  - Rebalancing
    - 리밸런싱이 활성화 되어 컨슈머 그룹 내의 파티션 할당이 변경중인 상태이다. 
  - Empty:
    - 특정 파티션에 대해 할당된 컨슈머가 없는 상태이다. 
    - 이 상태는 파티션에 대하 할당이 아직 이루어 지지 않았거나, 할당된 컨슈머가 아무런 메시지도 소비하지 않는 경우에 나타낸다. 
  - Dead:
    - 컨슈머가 비정상적으로 종료되어 있거나, 통신이 끊어진 경우 등 컨슈머의 상태가 불안정한 경우를 나타낸다. 

## Consumer Rebalancing이나 Consumer Preparing Rebalance 원인

- 리밸런싱이나 리밸런싱 준비는 컨슈머 그랩 내의 컨슈머 인스턴스들 간의 파티션 할당이 변경되는 과정을 나타낸다. 
- 새로운 컨슈머가 그룹에 합류하거나, 기존 컨슈머가 종료되었을 때, 또는 그룹 구성이 변경 되었을때 발생할 수 있다. 

- 발생 조건
  - 새로운 Consumer가 그룹에 합류한경우
    - 새로운 컨슈머가 그룹에 합류하면 리밸런싱이 발생한다. 
    - 이 컨슈머는 그룹에 참여하고자 할 때, 그룹 코디네이터에게 파티션 할당을 요청하게 되며, 이로 인해 리밸런싱이 시작된다. 
  - 기존 Consumer가 그룹을 떠날때
    - 기존 할당받은 파티션을 소유하던 컨슈머가 그룹을 떠날 때 리밸런싱이 발생한다. 
    - 컨슈머가 정상 종료되거나, 세션이 만료된 경우 리밸런싱이 발생할 수 있다. 
  - 그룹 구성이 변경될 때
    - 그룹 내 컨슈머 구성이 변경되면 리밸런싱이 발생한다. 
    - 예를 들어, 컨슈머 그룹의 구성이 동적으로 변경되면 (컨슈머 인스턴스의 추가 또는 제거), 리밸런싱이 트리거 된다. 
  - 파티션의 할당이 변경될 때
    - 파티션의 소유자가 변경되거나, 새로운 파티션이 추가되면 리밸런싱이 발생할 수 있다. 
    - 이는 파티션의 소유자가 변경되어야 하는 상황에서 자동으로 수행된다. 

- 컨슈머 리밸런싱은 그룹의 공평한 파티션 할당을 보장하고, 각 컨슈머 인스턴스가 균등하게 작업을 수행할 수 있도록 하는 중요한 메커니즘이다. 
- 그러나 불필요한 리밸런싱은 성능에 영향을 미칠 수 있으므로, 적절한 컨슈머 그룹 구성과 파티션 할당이 중요하다. 

## 리밸런싱 발생시 메시지 중복이슈

- 컨슈머가 2개이고 파티션이 1개인경우에 리밸런싱이 발생하면 동일한 메시지가 중복으로 발생하는 현상이 생길 수 있다 
- 이 문제를 해결하기 위한 몇가지 방법은 다음과 같다. 
- 1. 파티션 늘리기
  - 파티션을 여러개로 늘려서 가각의 파티션에 컨슈머를 할당함으로 써 리밸런싱이 발생해도 중복 메시지를 최소화 할 수 있다. 
  - 파티션의 수는 컨슈머의 수보다 크거나 같아야한다. 
  - ```
  kafka-topics.sh --zookeeper <zookeeper_address> --alter --topic <topic_name> --partitions <new_partition_count>
  ```
- 2. Consumer Group ID 설정
  - 컨슈머 그룹의 ID를 명시적으로 설저하여 컨슈머 그룹 간에 파티션을 공유하지 않도록 한다. 
  - 이를 통해서 컨슈머 그룹 간에 메시지 중복으로 컨슘되는 것을 방지할 수 있다. 
  - ```
  properties.put("group.id", "your_unique_consumer_group_id");
  ```
- 3. Auto Commit 비 활성화
  - 자동 커밋을 비활성화 하고, 수동으로 커밋하도록 설정한다. 
  - 이렇게 하면 메시지를 성공적으로 처리한 후에 커밋이 이루어 지므로 중복 메시지를 최소화 할 수 있다. 
  - ```
  properties.put("enable.auto.commit", "false");
  ```
- 4. At-Least-Once 소비방식 구현
  - 메시지를 최소 한번 이상 소비하더라도 시스템이 안전하게 처리될 수 있도록 소비자 애플리케이션을 구현한다. 
  - 이를 통해 중복 메시지가 발생하더라도 안전하게 처리할 수 있다. 


- 위 설정으로 리밸런싱 메시지 중복을 최소화 할 수 있다. 
- 그러나 100% 중복을 발생하는 것을 막는것은 어려울 수 있으므로 애플리케이션에서 중복 메시지를 처리할 수 있도록 설계하는 것이 좋다. 


## Consumer의 오프셋 설정

- auto.offset.reset 은 Apache Kafka의 컨슈머 설정중 하나로 컨슈머가 파티션의 offset을 찾을 수 없을때 초기 오프셋을 어떻게 설정할지 지정한다. 
- auto.offset.reset 속성 옵션은 다음과 같다. 
  - earliest:
    - 컨슈머가 해당 파티션에 대한 오프셋을 찾을 수 없을 때, 가장 이전에 저장된 메시지부터 소비를 시작한다. 
    - 즉, 가장 초기의 오프셋부터 데이터를 가져오게 된다. 
  - latest:
    - 컨슈머가 해당 파티션에 대한 오프셋을 찾을 수 없을 때, 현재 생산중인 메시지부터 소비를 시작한다. 
    - 즉, 가장 최근에 생산된 메시지부터 데이터를 가져오게 된다. 
  - none:
    - 컨슈머가 파티션에 대한 오프셋을 찾을 수없게 되면 에러가 발생한다. 
    - 이 경우 컨슈머는 예외를 던지고 소비를 시작하지 않는다. 

